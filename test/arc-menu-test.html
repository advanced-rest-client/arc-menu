<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <script src="../../webcomponentsjs/webcomponents-loader.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <link rel="import" href="../../app-pouchdb/pouchdb.html">
    <link rel="import" href="../../arc-models/rest-api-model.html">
    <link rel="import" href="../../arc-models/project-model.html">
    <link rel="import" href="../../arc-models/request-model.html">
    <link rel="import" href="../arc-menu.html">
  </head>
  <body>
    <rest-api-model></rest-api-model>
    <project-model></project-model>
    <request-model></request-model>

    <test-fixture id="History">
      <template>
        <arc-menu history-enabled></arc-menu>
      </template>
    </test-fixture>

    <test-fixture id="Saved">
      <template>
        <arc-menu selected="1"></arc-menu>
      </template>
    </test-fixture>

    <test-fixture id="Projects">
      <template>
        <arc-menu selected="2"></arc-menu>
      </template>
    </test-fixture>

    <test-fixture id="Apis">
      <template>
        <arc-menu selected="3"></arc-menu>
      </template>
    </test-fixture>

    <test-fixture id="NoHistory">
      <template>
        <arc-menu history-enabled hide-history></arc-menu>
      </template>
    </test-fixture>

    <test-fixture id="NoSaved">
      <template>
        <arc-menu history-enabled hide-saved></arc-menu>
      </template>
    </test-fixture>

    <test-fixture id="NoProjects">
      <template>
        <arc-menu history-enabled hide-projects></arc-menu>
      </template>
    </test-fixture>

    <test-fixture id="NoApis">
      <template>
        <arc-menu history-enabled hide-apis></arc-menu>
      </template>
    </test-fixture>

    <test-fixture id="HistoryDisabled">
      <template>
        <arc-menu></arc-menu>
      </template>
    </test-fixture>

    <test-fixture id="Popups">
      <template>
        <arc-menu history-enabled allow-popup></arc-menu>
      </template>
    </test-fixture>

    <script>
    suite('basic', function() {
      test('Opens default menu', (done) => {
        const element = fixture('History');
        flush(() => {
          const node = element.shadowRoot.querySelector('history-menu');
          assert.ok(node);
          done();
        });
      });

      test('Opens saved menu', (done) => {
        const element = fixture('Saved');
        flush(() => {
          const node = element.shadowRoot.querySelector('saved-menu');
          assert.ok(node);
          done();
        });
      });

      test('Opens projects menu', (done) => {
        const element = fixture('Projects');
        flush(() => {
          const node = element.shadowRoot.querySelector('projects-menu');
          assert.ok(node);
          done();
        });
      });

      test('Opens APIs menu', (done) => {
        const element = fixture('Apis');
        flush(() => {
          const node = element.shadowRoot.querySelector('rest-api-menu');
          assert.ok(node);
          done();
        });
      });

      test('Does not render history if history-enabled is not set', (done) => {
        const element = fixture('HistoryDisabled');
        flush(() => {
          const node = element.shadowRoot.querySelector('history-menu');
          assert.notOk(node);
          done();
        });
      });
    });

    suite('history-hidden', function() {
      test('Selects saved menu', () => {
        const element = fixture('NoHistory');
        assert.equal(element.selected, 1);
      });

      test('Selects projects menu when saved is also hidden', () => {
        const element = fixture('NoHistory');
        element.hideSaved = true;
        assert.equal(element.selected, 2);
      });

      test('History is hidden when historyHidden is set', (done) => {
        const element = fixture('NoHistory');
        element.selected = 0;
        flush(() => {
          const node = element.shadowRoot.querySelector('history-menu');
          assert.notOk(node);
          done();
        });
      });

      test('History tab is hidden', (done) => {
        const element = fixture('NoHistory');
        flush(() => {
          const node = element.shadowRoot.querySelectorAll('paper-tab')[0];
          assert.isTrue(node.hasAttribute('hidden'));
          done();
        });
      });
    });

    suite('saved-hidden', function() {
      test('Keeps default selection', () => {
        const element = fixture('NoSaved');
        assert.equal(element.selected, 0);
      });

      test('Saved panel is not rendered', (done) => {
        const element = fixture('NoSaved');
        element.selected = 1;
        flush(() => {
          const node = element.shadowRoot.querySelector('saved-menu');
          assert.notOk(node);
          done();
        });
      });

      test('Saved tab is hidden', (done) => {
        const element = fixture('NoSaved');
        flush(() => {
          const node = element.shadowRoot.querySelectorAll('paper-tab')[1];
          assert.isTrue(node.hasAttribute('hidden'));
          done();
        });
      });
    });

    suite('projects-hidden', function() {
      test('Keeps default selection', () => {
        const element = fixture('NoProjects');
        assert.equal(element.selected, 0);
      });

      test('Projects panel is not rendered', (done) => {
        const element = fixture('NoProjects');
        element.selected = 2;
        flush(() => {
          const node = element.shadowRoot.querySelector('projects-menu');
          assert.notOk(node);
          done();
        });
      });

      test('Projects tab is hidden', (done) => {
        const element = fixture('NoProjects');
        flush(() => {
          const node = element.shadowRoot.querySelectorAll('paper-tab')[2];
          assert.isTrue(node.hasAttribute('hidden'));
          done();
        });
      });
    });

    suite('apis-hidden', function() {
      test('Keeps default selection', () => {
        const element = fixture('NoApis');
        assert.equal(element.selected, 0);
      });

      test('Apis panel is not rendered', (done) => {
        const element = fixture('NoApis');
        element.selected = 3;
        flush(() => {
          const node = element.shadowRoot.querySelector('rest-api-menu');
          assert.notOk(node);
          done();
        });
      });

      test('Apis tab is hidden', (done) => {
        const element = fixture('NoApis');
        flush(() => {
          const node = element.shadowRoot.querySelectorAll('paper-tab')[3];
          assert.isTrue(node.hasAttribute('hidden'));
          done();
        });
      });
    });

    suite('_navigateScreen()', () => {
      let element;
      setup(() => {
        element = fixture('History');
      });

      test('Dispatches "navigate" event', () => {
        const spy = sinon.spy();
        element.addEventListener('navigate', spy);
        element._navigateScreen('test');
        assert.isTrue(spy.called);
      });

      test('Detail has base', () => {
        const spy = sinon.spy();
        element.addEventListener('navigate', spy);
        element._navigateScreen('test');
        assert.equal(spy.args[0][0].detail.base, 'test');
      });

      test('Event bubbles', () => {
        const spy = sinon.spy();
        element.addEventListener('navigate', spy);
        element._navigateScreen('test');
        assert.isTrue(spy.args[0][0].bubbles);
      });

      test('Event is cancelable', () => {
        const spy = sinon.spy();
        element.addEventListener('navigate', spy);
        element._navigateScreen('test');
        assert.isTrue(spy.args[0][0].cancelable);
      });

      test('Event is composed', () => {
        const spy = sinon.spy();
        element.addEventListener('navigate', spy);
        element._navigateScreen('test');
        const composed = spy.args[0][0].composed;
        if (composed !== undefined) {
          // edge test...,
          assert.isTrue(composed);
        }
      });
    });

    suite('Panels navigation', () => {
      let element;
      setup((done) => {
        element = fixture('History');
        flush(() => done());
      });

      test('_openHistoryList() opens history screen', () => {
        const spy = sinon.spy(element, '_navigateScreen');
        element._openHistoryList();
        assert.isTrue(spy.called);
        assert.equal(spy.args[0][0], 'history');
      });

      test('Open history button calls _openHistoryList()', () => {
        const spy = sinon.spy(element, '_openHistoryList');
        const node = element.shadowRoot.querySelector('[data-action="open-history"]');
        node.click();
        assert.isTrue(spy.called);
      });

      test('_openSavedList() opens history screen', () => {
        const spy = sinon.spy(element, '_navigateScreen');
        element._openSavedList();
        assert.isTrue(spy.called);
        assert.equal(spy.args[0][0], 'saved');
      });

      test('Open history button calls _openHistoryList()', () => {
        element.selected = 1;
        flush(() => {
          const spy = sinon.spy(element, '_openSavedList');
          const node = element.shadowRoot.querySelector('[data-action="open-saved"]');
          node.click();
          assert.isTrue(spy.called);
        });
      });

      test('_openSavedList() opens history screen', () => {
        const spy = sinon.spy(element, '_navigateScreen');
        element._openApisList();
        assert.isTrue(spy.called);
        assert.equal(spy.args[0][0], 'rest-projects');
      });

      test('Open history button calls _openHistoryList()', () => {
        element.selected = 3;
        flush(() => {
          const spy = sinon.spy(element, '_openApisList');
          const node = element.shadowRoot.querySelector('[data-action="open-rest-apis"]');
          node.click();
          assert.isTrue(spy.called);
        });
      });

      test('_exporeApis() opens history screen', () => {
        const spy = sinon.spy(element, '_navigateScreen');
        element._exporeApis();
        assert.isTrue(spy.called);
        assert.equal(spy.args[0][0], 'exchange-search');
      });

      test('Open history button calls _openHistoryList()', () => {
        element.selected = 3;
        flush(() => {
          const spy = sinon.spy(element, '_exporeApis');
          const node = element.shadowRoot.querySelector('[data-action="explore-rest-apis"]');
          node.click();
          assert.isTrue(spy.called);
        });
      });
    });

    suite('Refreshing panels', () => {
      let element;
      setup((done) => {
        element = fixture('History');
        flush(() => done());
      });

      test('_refreshList() calls refresh() on a panel', () => {
        const panel = element.shadowRoot.querySelector('history-menu');
        const spy = sinon.spy(panel, 'refresh');
        element._refreshList('history-menu');
        assert.isTrue(spy.called);
      });

      test('_refreshList() does nothing when panel do not exist', () => {
        element._refreshList('other-menu');
        // no error, coverage
      });

      test('refreshHistoryList() calls _refreshList() with argument', (done) => {
        element.selected = 0;
        flush(() => {
          const spy = sinon.spy(element, '_refreshList');
          element.refreshHistoryList();
          assert.isTrue(spy.called);
          assert.equal(spy.args[0][0], 'history-menu');
          done();
        });
      });

      test('Refresh history button calls refreshHistoryList()', () => {
        const spy = sinon.spy(element, 'refreshHistoryList');
        const node = element.shadowRoot.querySelector('[data-action="refresh-history"]');
        node.click();
        assert.isTrue(spy.called);
      });

      test('refreshSavedList() calls _refreshList() with argument', () => {
        const spy = sinon.spy(element, '_refreshList');
        element.refreshSavedList();
        assert.isTrue(spy.called);
        assert.equal(spy.args[0][0], 'saved-menu');
      });

      test('Refresh history button calls refreshSavedList()', (done) => {
        element.selected = 1;
        flush(() => {
          const spy = sinon.spy(element, 'refreshSavedList');
          const node = element.shadowRoot.querySelector('[data-action="refresh-saved"]');
          node.click();
          assert.isTrue(spy.called);
          done();
        });
      });

      test('refreshProjectsList() calls _refreshList() with argument', () => {
        const spy = sinon.spy(element, '_refreshList');
        element.refreshProjectsList();
        assert.isTrue(spy.called);
        assert.equal(spy.args[0][0], 'projects-menu');
      });

      test('Refresh history button calls refreshProjectsList()', (done) => {
        element.selected = 2;
        flush(() => {
          const spy = sinon.spy(element, 'refreshProjectsList');
          const node = element.shadowRoot.querySelector('[data-action="refresh-projects"]');
          node.click();
          assert.isTrue(spy.called);
          done();
        });
      });

      test('refreshApisList() calls _refreshList() with argument', () => {
        const spy = sinon.spy(element, '_refreshList');
        element.refreshApisList();
        assert.isTrue(spy.called);
        assert.equal(spy.args[0][0], 'rest-api-menu');
      });

      test('Refresh history button calls refreshApisList()', (done) => {
        element.selected = 3;
        flush(() => {
          const spy = sinon.spy(element, 'refreshApisList');
          const node = element.shadowRoot.querySelector('[data-action="refresh-rest-apis"]');
          node.click();
          assert.isTrue(spy.called);
          done();
        });
      });
    });

    suite('_popupMenu()', () => {
      let element;
      setup((done) => {
        element = fixture('Popups');
        flush(() => done());
      });

      test('Dispatches "popup-menu" event', () => {
        const spy = sinon.spy();
        element.addEventListener('popup-menu', spy);
        element._popupMenu('test');
        assert.isTrue(spy.called);
      });

      test('Event is not dispatched when no allow-popup', () => {
        element.allowPopup = false;
        const spy = sinon.spy();
        element.addEventListener('popup-menu', spy);
        element._popupMenu('test');
        assert.isFalse(spy.called);
      });

      test('Detail has type', () => {
        const spy = sinon.spy();
        element.addEventListener('popup-menu', spy);
        element._popupMenu('test');
        assert.equal(spy.args[0][0].detail.type, 'test');
      });

      test('Event bubbles', () => {
        const spy = sinon.spy();
        element.addEventListener('popup-menu', spy);
        element._popupMenu('test');
        assert.isTrue(spy.args[0][0].bubbles);
      });

      test('Event is cancelable', () => {
        const spy = sinon.spy();
        element.addEventListener('popup-menu', spy);
        element._popupMenu('test');
        assert.isTrue(spy.args[0][0].cancelable);
      });

      test('Event is composed', () => {
        const spy = sinon.spy();
        element.addEventListener('popup-menu', spy);
        element._popupMenu('test');
        const composed = spy.args[0][0].composed;
        if (composed !== undefined) {
          // edge test...,
          assert.isTrue(composed);
        }
      });
    });

    suite('Popuping menus', () => {
      let element;
      setup((done) => {
        element = fixture('Popups');
        flush(() => done());
      });

      test('popupHistory() calls _popupMenu() with an argument', () => {
        const spy = sinon.spy(element, '_popupMenu');
        element.popupHistory();
        assert.isTrue(spy.called);
        assert.equal(spy.args[0][0], 'history-menu');
      });

      test('Popup history button calls popupHistory()', () => {
        const spy = sinon.spy(element, 'popupHistory');
        const node = element.shadowRoot.querySelector('[data-action="popup-history"]');
        node.click();
        assert.isTrue(spy.called);
      });

      test('popupSaved() calls _popupMenu() with an argument', () => {
        const spy = sinon.spy(element, '_popupMenu');
        element.popupSaved();
        assert.isTrue(spy.called);
        assert.equal(spy.args[0][0], 'saved-menu');
      });

      test('Popup history button calls popupSaved()', (done) => {
        element.selected = 1;
        flush(() => {
          const spy = sinon.spy(element, 'popupSaved');
          const node = element.shadowRoot.querySelector('[data-action="popup-saved"]');
          node.click();
          assert.isTrue(spy.called);
          done();
        });
      });

      test('popupProjects() calls _popupMenu() with an argument', () => {
        const spy = sinon.spy(element, '_popupMenu');
        element.popupProjects();
        assert.isTrue(spy.called);
        assert.equal(spy.args[0][0], 'projects-menu');
      });

      test('Popup history button calls popupProjects()', (done) => {
        element.selected = 2;
        flush(() => {
          const spy = sinon.spy(element, 'popupProjects');
          const node = element.shadowRoot.querySelector('[data-action="popup-saved"]');
          node.click();
          assert.isTrue(spy.called);
          done();
        });
      });

      test('popupApis() calls _popupMenu() with an argument', () => {
        const spy = sinon.spy(element, '_popupMenu');
        element.popupApis();
        assert.isTrue(spy.called);
        assert.equal(spy.args[0][0], 'rest-api-menu');
      });

      test('Popup history button calls popupApis()', (done) => {
        element.selected = 3;
        flush(() => {
          const spy = sinon.spy(element, 'popupApis');
          const node = element.shadowRoot.querySelector('[data-action="popup-rest-apis"]');
          node.click();
          assert.isTrue(spy.called);
          done();
        });
      });
    });

    suite('_toggleSavedWarning()', () => {
      let element;
      setup((done) => {
        element = fixture('HistoryDisabled');
        element.selected = 1;
        flush(() => done());
      });

      test('Toggles _savedWarningOpened', () => {
        element._toggleSavedWarning();
        assert.isTrue(element._savedWarningOpened);
      });

      test('Toggle message button calls the function', () => {
        const spy = sinon.spy(element, '_toggleSavedWarning');
        const node = element.shadowRoot.querySelector('[data-action="toggle-saved-removal-messsage"]');
        node.click();
        assert.isTrue(spy.called);
      });
    });

    suite('_openSavedRemovalTicket()', () => {
      let element;
      setup((done) => {
        element = fixture('HistoryDisabled');
        element.selected = 1;
        flush(() => done());
      });

      test('Dispatches open-external-url event', () => {
        let called = false;
        element.addEventListener('open-external-url', function f(e) {
          element.addEventListener('open-external-url', f);
          e.preventDefault();
          called = true;
        });
        element._openSavedRemovalTicket();
        assert.isTrue(called);
      });

      test('The event has url', () => {
        let detail;
        element.addEventListener('open-external-url', function f(e) {
          element.addEventListener('open-external-url', f);
          e.preventDefault();
          detail = e.detail;
        });
        const url = 'https://github.com/advanced-rest-client/arc-electron/issues/80';
        element._openSavedRemovalTicket();
        assert.equal(detail.url, url);
      });
    });

    suite('Auto change selection', () => {
      let element;
      setup((done) => {
        element = fixture('History');
        flush(() => done());
      });

      test('Calls _updateSelectionIfNeeded with an argument when no value', () => {
        const spy = sinon.spy(element, '_updateSelectionIfNeeded');
        element._historyEnabledChanegd(false, true);
        assert.isTrue(spy.called);
        assert.equal(spy.args[0][0], 0);
      });

      test('Sets selection to 0 when re-enabling history', () => {
        element.historyEnabled = false;
        element.selected = 1;
        element._historyEnabledChanegd(true, false);
        assert.equal(element.selected, 0);
      });
    });
    </script>

  </body>
</html>
